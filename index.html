<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Infosk√¶rm ‚Äî TV safe</title>
<style>
  /* Basic, TV-friendly styling */
  :root{
    --overlay: rgba(255,255,255,0.85);
    --fg:#1e293b;
    --accent:#007bff;
  }
  html,body{height:100%;margin:0;background:linear-gradient(135deg,#e8f0ff,#f9fbff);font-family:system-ui,Segoe UI,Roboto,Arial;}
  .stage{position:relative;width:100%;height:100%;overflow:hidden;}
  /* full-screen background image (under everything) */
  #bgImage{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;filter:brightness(0.95);}
  .overlay{position:relative;z-index:10;padding:12px;}
  /* slides (welcome / vikarskema / custom slide) */
  .slide{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;text-align:center;padding:4%;z-index:11;pointer-events:none;opacity:0;transition:opacity .6s;}
  .slide.active{opacity:1;pointer-events:auto;}
  .text{font-weight:700;color:var(--fg);font-size:clamp(28px,5vw,64px);background:var(--overlay);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.12);}
  /* small UI pieces */
  .logo{position:fixed;left:12px;top:12px;z-index:15;background:var(--overlay);padding:8px;border-radius:10px;}
  .datetime{position:fixed;right:12px;top:12px;z-index:15;background:var(--overlay);padding:10px;border-radius:10px;text-align:right;}
  .schedule{position:fixed;right:12px;bottom:12px;z-index:15;background:var(--overlay);padding:8px;border-radius:10px;max-width:420px;overflow:hidden;}
  #infoBox{position:fixed;left:12px;bottom:12px;z-index:15;background:var(--overlay);padding:12px;border-radius:10px;min-width:260px;max-width:48vw;}
  /* banners */
  #morgensamlingSlide,#gardvagtSlide{position:fixed;left:50%;transform:translateX(-50%);top:20px;z-index:20;display:none;padding:8px;border-radius:12px;}
  #morgensamlingSlide.active,#gardvagtSlide.active{display:block;}
  #morgensamlingText,#gardvagtText{background:rgba(255,0,0,.95);color:#fff;padding:18px 28px;border-radius:12px;font-weight:800;box-shadow:0 8px 30px rgba(255,0,0,.15);}

  /* vikarskema box inside slide */
  .vikarskema{background:rgba(255,255,255,.9);padding:12px;border-radius:12px;max-width:96vw;max-height:86vh;overflow:auto;box-shadow:0 6px 20px rgba(0,0,0,.12);}
  .vikarskema table{width:100%;border-collapse:collapse;font-size:clamp(12px,1.6vw,18px);}
  .vikarskema th{background:var(--accent);color:#fff;padding:6px}
  .vikarskema td{padding:6px;border:1px solid rgba(0,0,0,.06);text-align:center}
  .vikarskema tr.current{background:rgba(0,123,255,0.12)}
  /* responsive safe */
  @media (max-width:600px){ .text{font-size:20px} .schedule{display:none} }
</style>
</head>
<body>

<div class="stage">

  <!-- Background image (single element) -->
  <img id="bgImage" src="" alt="" aria-hidden="true">

  <!-- Slides -->
  <div class="slide active" id="welcomeSlide"><div class="text">üëã Velkommen til Al Irchad skolen</div></div>

  <div class="slide" id="customSlide"><div class="text" id="customContent">Indl√¶ser billeder‚Ä¶</div></div>

  <div class="slide" id="vikarSlide" aria-hidden="true">
    <div class="vikarskema">
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:12px;font-weight:700;">
        <div>Vikarskema</div>
        <div>üìÖ <span id="vikarskemaDate">‚Äì</span></div>
        <div>‚è∞ <span id="vikarskemaClock">‚Äì:‚Äì:‚Äì</span></div>
      </div>
      <div id="vikarskemaContent">Indl√¶ser vikarskema‚Ä¶</div>
    </div>
  </div>

</div>

<!-- Overlays -->
<div class="logo overlay"><img src="https://www.al-irchadskolen.dk/wp-content/uploads/2024/03/images.png" alt="logo" style="height:56px"></div>
<div class="datetime overlay"><div id="dateText">‚Äì</div><div id="timeText" style="font-weight:700">‚Äì</div></div>
<div id="infoBox" class="overlay">Henter info‚Ä¶</div>
<div class="schedule overlay" id="schedule">Indl√¶ser skema‚Ä¶</div>

<!-- Banners -->
<div id="morgensamlingSlide"><div id="morgensamlingText">‚è∞ Det er tid til morgensamling!</div></div>
<div id="gardvagtSlide"><div id="gardvagtText">üîî G√•rdvagt!</div></div>

<!-- Audio elements ‚Äî use raw.githubusercontent URLs (see notes below) -->
<audio id="morgensamlingSound" preload="auto" src="https://raw.githubusercontent.com/ihayek86-spec/Infoscreen/a45ddd605ea18a69772f1352c39d63a2d9748be2/sounds/morgensamling.mp3"></audio>
<audio id="huskGardvagtSound" preload="auto" src="https://raw.githubusercontent.com/ihayek86-spec/Infoscreen/a45ddd605ea18a69772f1352c39d63a2d9748be2/sounds/husk_gardvagt.mp3"></audio>

<script>
/* ========== CONFIG ========== */
/* Keep fetch intervals conservative for TV (seconds) */
const FETCH_IMAGES_INTERVAL = 30000;   // 30s fetch google sheet images
const FETCH_VIKAR_INTERVAL  = 60000;   // 60s vikarskema
const FETCH_INFO_INTERVAL   = 60000;   // 60s info/weather
const SLIDE_WELCOME_MS      = 5000;
const SLIDE_IMAGE_MS        = 5000;
const SLIDE_VIKAR_MS        = 30000;

/* Replace these URLs with your own scripts if needed */
const customWebhookUrl = "https://script.google.com/macros/s/AKfycbwic1LHHatZ_tAehcE4Hvb-QV-m_ua0k0Hedgre_URMhm8Sva2Bf3QltFN9tOCiJJP1Xw/exec";
const vikarUrl = "https://script.google.com/macros/s/AKfycbyQ5e7UHSmfxdAGJgfAo7mHHnH37ktEIHO0QPEP7TxOlSZ0Tb5lwTAO_9MBtqZG4vSvWw/exec";
const infoSheetUrl = "https://script.google.com/macros/s/AKfycbwPfXNL6-gcGdxDWd8FXeBej4mJFnutlgApxtzPelYwk2W_L1MoQS8kYpHunsB17PYutA/exec";

/* ========== DOM ========== */
const bgImage = document.getElementById('bgImage');
const slides = {
  welcome: document.getElementById('welcomeSlide'),
  custom: document.getElementById('customSlide'),
  vikar: document.getElementById('vikarSlide')
};
const customContent = document.getElementById('customContent');
const infoBox = document.getElementById('infoBox');
const scheduleEl = document.getElementById('schedule');
const vikarContent = document.getElementById('vikarskemaContent');
const vikarDateEl = document.getElementById('vikarskemaDate');
const vikarClockEl = document.getElementById('vikarskemaClock');
const dateText = document.getElementById('dateText');
const timeText = document.getElementById('timeText');
const morgensamlingSound = document.getElementById('morgensamlingSound');
const huskGardvagtSound = document.getElementById('huskGardvagtSound');
const morgensamlingBanner = document.getElementById('morgensamlingSlide');
const gardvagtBanner = document.getElementById('gardvagtSlide');

/* ========== Date & Time ========== */
function updateDateTime(){
  const now = new Date();
  dateText.textContent = now.toLocaleDateString('da-DK', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  timeText.textContent = now.toLocaleTimeString('da-DK', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
  vikarDateEl.textContent = now.toLocaleDateString('da-DK', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  vikarClockEl.textContent = now.toLocaleTimeString('da-DK', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
}
setInterval(updateDateTime,1000);
updateDateTime();

/* ========== Simple safe fetch wrapper ========== */
async function safeJsonFetch(url, timeout = 15000){
  try{
    const controller = new AbortController();
    const id = setTimeout(()=>controller.abort(), timeout);
    const res = await fetch(url, { signal: controller.signal });
    clearTimeout(id);
    if(!res.ok) throw new Error('HTTP '+res.status);
    return await res.json();
  }catch(e){
    console.warn('fetch failed', url, e);
    return null;
  }
}

/* ========== InfoBox (weather + sheet rows) ========== */
let sheetRows = [];
let infoIndex = 0;
async function fetchInfoAndWeather(){
  // weather from open-meteo (low network)
  try{
    const w = await safeJsonFetch("https://api.open-meteo.com/v1/forecast?latitude=56.03&longitude=12.59&current_weather=true&temperature_unit=celsius", 12000);
    const weatherText = w && w.current_weather ? `Vind ${w.current_weather.windspeed} km/t, ${Math.round(w.current_weather.temperature)}¬∞C` : "Vejr: -";
    // sheet text rows
    const sheet = await safeJsonFetch(infoSheetUrl, 12000);
    sheetRows = (sheet && (sheet.sheets?.[0]?.rows || sheet.rows)) || [["Ingen info"]];
    // set info items array
    infoItems = [ () => `‚òÄÔ∏è Vejr i Helsing√∏r: ${weatherText}` , ...sheetRows.map(r=>() => r.join(' | ')) ];
  }catch(e){
    infoItems = [ () => "Fejl ved hentning af info" ];
  }
}
let infoItems = [ () => "Henter..." ];
async function rotateInfoBox(){
  if(!infoItems || infoItems.length === 0) return;
  infoBox.style.opacity = 0;
  setTimeout(()=>{
    const fn = infoItems[infoIndex % infoItems.length];
    infoBox.textContent = typeof fn === 'function' ? fn() : String(fn);
    infoBox.style.opacity = 1;
    infoIndex++;
  }, 600);
}
fetchInfoAndWeather().then(()=>rotateInfoBox());
setInterval(fetchInfoAndWeather, FETCH_INFO_INTERVAL);
setInterval(rotateInfoBox, 10000);

/* ========== Vikarskema ========== */
async function updateVikarskema(){
  const data = await safeJsonFetch(vikarUrl, 15000);
  if(!data){ vikarContent.innerHTML = "<em>Fejl ved indl√¶sning</em>"; return; }
  // Build table (defensive)
  const headers = data.headers || [];
  const rows = data.rows || [];
  let html = '<table><thead><tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr></thead><tbody>';
  rows.forEach(r=>{
    html += '<tr>'+r.map(c=> (typeof c === 'string' && c.match(/\.(jpg|jpeg|png|gif|webp)$/i)) ? `<td><img src="${c}" style="max-width:120px;max-height:80px;border-radius:6px"></td>` : `<td>${c}</td>` ).join('') +'</tr>';
  });
  html += '</tbody></table>';
  vikarContent.innerHTML = html;
  highlightCurrentVikarskemaRow();
}
async function highlightCurrentVikarskemaRow(){
  try{
    const now = new Date();
    const nowMin = now.getHours()*60 + now.getMinutes();
    vikarContent.querySelectorAll('tbody tr').forEach(tr => tr.classList.remove('current'));
    vikarContent.querySelectorAll('tbody tr').forEach(tr=>{
      const t = (tr.cells[0] && tr.cells[0].textContent) ? tr.cells[0].textContent.trim() : '';
      if(!t || t.indexOf('-')<0) return;
      const [s,e] = t.split('-').map(s=>s.trim());
      const [sh,sm] = s.split(':').map(Number);
      const [eh,em] = e.split(':').map(Number);
      if(isNaN(sh)) return;
      const start = sh*60 + (isNaN(sm) ? 0 : sm);
      const end = eh*60 + (isNaN(em) ? 0 : em);
      if(nowMin >= start && nowMin < end) tr.classList.add('current');
    });
  }catch(e){}
}
updateVikarskema();
setInterval(updateVikarskema, FETCH_VIKAR_INTERVAL);

/* ========== Schedule (static local) ========== */
const schedules={1:{title:"G√•rdvagtskema", rows:[["9:10-09:20","PP","EY","JL","TN","MA"],["10:50-11:15","PP","NC","LC","JD","MA"],["12:35-12:50","PP","JL","KP","JD","SR"]]},2:{title:"G√•rdvagtskema", rows:[["9:10-09:20","NC","EY","EK","TN","IR"],["10:50-11:15","MD","EY","EK","TN","IR"],["12:35-12:50","MD","JL","EK","IH","SR"]]},3:{title:"G√•rdvagtskema", rows:[["9:10-09:20","NC","AD","SJ","LL","JL"],["10:50-11:15","ZA","AD","SJ","IH","LL"],["12:35-12:50","ZA","AD","SJ","AFH","LL"]]},4:{title:"G√•rdvagtskema", rows:[["9:10-09:20","NC","EY","MB","AFH","MT"],["10:50-11:15","HR","LC","MP","MT","SR"],["12:35-12:50","MD","HR","MP","IH","JD"]]},5:{title:"G√•rdvagtskema",rows:[["9:10-09:20","AD","MB","KP","MT","MA"],["10:50-11:15","MA","MB","MP","AFH","MT"]]}};
function renderStaticSchedule(){
  const d = new Date().getDay();
  const sch = schedules[d] || null;
  if(!sch){ scheduleEl.innerHTML = ''; return; }
  let html = '<table style="border-collapse:collapse;width:100%"><thead><tr><th colspan="6">'+sch.title+'</th></tr><tr><th>Pause</th><th>SG1</th><th>SG2</th><th>MB3</th><th>SG4</th><th>G5</th></tr></thead><tbody>';
  sch.rows.forEach(r => html += '<tr>' + r.map(c => `<td style="border:1px solid rgba(0,0,0,.06);padding:4px">${c}</td>`).join('') + '</tr>');
  html += '</tbody></table>';
  scheduleEl.innerHTML = html;
}
renderStaticSchedule();

/* ========== G√•rdvagt and Morgensamling (play sounds + banner) ========== */
const gardvagtTimes = ["09:10","10:50","12:35"];
let lastMorgensamlingMinute = null;
let lastGardvagtMinute = null;

function checkTimeEvents(){
  const now = new Date();
  const minute = now.getMinutes();
  const currentMin = now.getHours()*60 + now.getMinutes();

  // Morgensamling: 08:20 - 08:25 (example)
  const mStart = 8*60 + 20, mEnd = mStart + 5;
  if(currentMin >= mStart && currentMin < mEnd){
    morgensamlingBanner.classList.add('active');
    // play once per minute
    if(lastMorgensamlingMinute !== minute){
      try{ morgensamlingSound.currentTime = 0; morgensamlingSound.play().catch(()=>{}); }catch(e){}
      lastMorgensamlingMinute = minute;
    }
  } else {
    morgensamlingBanner.classList.remove('active');
    lastMorgensamlingMinute = null;
  }

  // G√•rdvagt times (each 5 minute window)
  const active = gardvagtTimes.some(t=>{
    const [h,m] = t.split(':').map(Number);
    const s = h*60 + m;
    return currentMin >= s && currentMin < s + 5;
  });
  if(active){
    gardvagtBanner.classList.add('active');
    if(lastGardvagtMinute !== minute){
      try{ huskGardvagtSound.currentTime = 0; huskGardvagtSound.play().catch(()=>{}); }catch(e){}
      lastGardvagtMinute = minute;
    }
  } else {
    gardvagtBanner.classList.remove('active');
    lastGardvagtMinute = null;
  }
}
setInterval(checkTimeEvents,5000);
checkTimeEvents();

/* ========== Image slideshow (from Google Sheet webhook) ========== */
let customData = []; // array of rows (each row may be array or object)
let currentBatchIndex = 0;
const batchSize = 3;

async function fetchCustomData(){
  const data = await safeJsonFetch(customWebhookUrl, 15000);
  if(!data) return;
  customData = Array.isArray(data) ? data : (data.rows || data.sheets?.[0]?.rows || []);
  // normalize to array-of-urls: keep only rows with at least one image url
  customData = customData.filter(r => {
    if(Array.isArray(r)) return r.some(c => typeof c==='string' && c.match(/\.(jpg|jpeg|png|gif|webp)$/i));
    if(typeof r === 'object' && r !== null) return Object.values(r).some(v => typeof v==='string' && v.match(/\.(jpg|jpeg|png|gif|webp)$/i));
    return false;
  });
}

async function showImage(url){
  if(!url){ bgImage.src = ''; return; }
  // set bg image (single element) to reduce DOM churn
  bgImage.src = url;
}

async function slideshowCycle(){
  // welcome
  setActive('welcome');
  await wait(SLIDE_WELCOME_MS);

  // images if any
  if(customData.length > 0){
    const batch = customData.slice(currentBatchIndex, currentBatchIndex + batchSize);
    for(const row of batch){
      let url = null;
      if(Array.isArray(row)) url = row.find(c => typeof c==='string' && c.match(/\.(jpg|jpeg|png|gif|webp)$/i));
      else if(typeof row === 'object') url = Object.values(row).find(v => typeof v==='string' && v.match(/\.(jpg|jpeg|png|gif|webp)$/i));
      if(url){
        setActive(null); // hide slides so overlays show over bg image
        await showImage(url);
        await wait(SLIDE_IMAGE_MS);
      }
    }
    currentBatchIndex += batchSize;
    if(currentBatchIndex >= customData.length) currentBatchIndex = 0;
  } else {
    // no images: show custom slide text
    setActive('custom');
    customContent.textContent = 'Ingen billeder i sheet';
    await wait(SLIDE_IMAGE_MS);
  }

  // vikarskema
  setActive('vikar');
  await wait(SLIDE_VIKAR_MS);

  // loop
  slideshowCycle();
}

/* helpers */
function wait(ms){ return new Promise(res => setTimeout(res, ms)); }
function setActive(name){
  Object.values(slides).forEach(el => el.classList.remove('active'));
  if(name && slides[name]) slides[name].classList.add('active');
}

/* initial load + intervals */
(async function init(){
  await fetchCustomData();
  slideshowCycle().catch(()=>{});
  setInterval(fetchCustomData, FETCH_IMAGES_INTERVAL);
})();

/* conservative auto-refresh of customData array for new rows */
setInterval(async ()=>{
  await fetchCustomData();
}, FETCH_IMAGES_INTERVAL);

/* allow audio to play on TV ‚Äî attempt to unmute after a user interaction (some TVs require it) */
function tryUnlockAudio(){
  [morgensamlingSound, huskGardvagtSound].forEach(a => {
    if(!a) return;
    a.muted = false;
    a.play()?.catch(()=>{ /* ignore */ });
    a.pause?.();
  });
  window.removeEventListener('click', tryUnlockAudio);
  window.removeEventListener('touchstart', tryUnlockAudio);
}
window.addEventListener('click', tryUnlockAudio, {passive:true});
window.addEventListener('touchstart', tryUnlockAudio, {passive:true});

</script>
</body>
</html>
