<!doctype html>
<html lang="da" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<title>Al Irchad skolen - Infosk√¶rm</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg: linear-gradient(135deg,#e8f0ff,#f9fbff);
  --fg:#1e293b;
  --overlay: rgba(255,255,255,0.85);
  --accent:#007bff;
  --gap:12px;
}
html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:'Tajawal',system-ui,sans-serif;overflow:hidden}

/* Main wrapper grid: left 60%, right 40% */
.wrapper {
  display: grid;
  grid-template-columns: 60% 40%; /* left 60%, right 40% */
  height: calc(100% - 20px);
  gap: var(--gap);
  padding: var(--gap);
  box-sizing: border-box;
}

/* Left panel: vikarskema */
.left-panel{display:flex;flex-direction:column;gap:var(--gap);}
.left-panel .panel{
  flex:1;
  background:rgba(255,255,255,0.35);
  border-radius:12px;
  padding:12px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  height:100%;
  backdrop-filter:blur(6px);
}

/* vikarskema table */
.vikarskema {
  background: rgba(255,255,255,0.5);
  padding: 16px;
  padding-right: 24px;
  border-radius: 16px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.1);
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  backdrop-filter: blur(3px);
  box-sizing: border-box;
}
.vikarskema table {
  width: 100%;
  border-collapse: collapse;
  font-size: clamp(14px, 2vw, 22px);
  table-layout: auto;
}
.vikarskema th,.vikarskema td {
  border: 1px solid rgba(0,0,0,0.12);
  padding: 6px 10px;
  text-align: center;
  white-space: nowrap;
}
.vikarskema th{background:var(--accent);color:white;font-weight:700}
.vikarskema tbody tr:nth-child(even){background:rgba(0,0,0,0.04)}
.vikarskema tbody tr.current{background:rgba(0,123,255,0.2) !important}
.vikarskema td:nth-child(6),.vikarskema th:nth-child(6){background:white;color:var(--fg)}
#vikarskemaHeader { display:flex;justify-content:flex-start;align-items:center;gap:20px;font-size:clamp(18px,1.4vw,26px);font-weight:700;margin-bottom:12px;flex-wrap:wrap;padding-left:60px; }
/* Right panel */
.right-panel {
  display: flex;
  flex-direction: column;
  gap: var(--gap);
  height: 100%;
}

/* Top panel (slideshow) */
.right-panel .panel.top {
  flex: 1 1 0;      /* fill remaining space */
  background: rgba(255,255,255,0.35);
  border-radius: 12px;
  padding: 12px;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
  backdrop-filter: blur(6px);
}

/* Image inside top panel */
#slideshowImage {
  max-height: 100%;  /* fit parent height */
  width: auto;       /* scale width automatically */
  object-fit: contain; /* maintain aspect ratio */
  display: block;
  border-radius: 18px;
}
.right-panel .panel.bottom{
  flex:0 0 250px;
  min-height:250px;
  background:rgba(255,255,255,0.35);
  border-radius:12px;
  padding:12px;
  display:flex;
  justify-content:center;
  align-items:center;
  overflow:auto;
  backdrop-filter:blur(6px);
}

/* Schedule table */
.schedule table {
  width: 100%;             /* fill the panel width */
  border-collapse: collapse; 
  table-layout: auto;      /* columns can have different widths */
}

.schedule th, .schedule td {
  border: 1px solid rgba(0,0,0,0.2); /* cell borders */
  padding: 6px 10px;
  text-align: center;
  white-space: nowrap;    /* text stays on one line */
}

.schedule th {
  background: var(--accent);
  color: white;
  font-weight: 700;
}

.schedule td {
  background: rgba(255,255,255,0.8);
}

/* InfoBox */
#infoBox{position:fixed;bottom:25px;right:16px;background:var(--overlay);backdrop-filter:blur(6px);color:var(--fg);padding:14px 20px;border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);font-size:clamp(16px,1.6vw,22px);font-weight:600;text-align:left;z-index:10000;opacity:0;transform:translateY(8px);transition:opacity .6s ease,transform .4s ease}
#infoBox.show{opacity:1;transform:translateY(0)}

/* datetime & logo */
.datetime { display:none; }
.logo{position:fixed;top:12px;left:16px;background:var(--overlay);padding:8px 12px;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,0.15);backdrop-filter:blur(6px);z-index:12000}
.logo img{height:48px;width:auto;opacity:0.95}


.panel {
  border-radius: 16px;               /* Rounded corners */
  box-shadow: 0 6px 20px rgba(0,0,0,0.1); /* Subtle shadow */
}

</style>
</head>
<body>

<div class="wrapper">

  <!-- Left: vikarskema -->
  <div class="left-panel">
    <div class="panel">
      <div class="vikarskema">
        <div id="vikarskemaHeader">
          <span id="vikarskemaTitle">Vikarskema</span>
          <span>üìÖ <span id="vikarskemaDate">‚Äì</span></span>
          <span>‚è∞ <span id="vikarskemaClock">‚Äì:‚Äì:‚Äì</span></span>
        </div>
        <div id="vikarskemaContent">Indl√¶ser vikarskema...</div>
      <div id="infoBox" aria-live="polite">Indl√¶ser information...</div>

      </div>
    </div>
  </div>

  <!-- Right: slideshow top + schedule bottom -->
  <div class="right-panel">
<div class="panel top">
  <img id="slideshowImage" style="display:none;" alt="slideshow">
 <video 
    id="slideshowVideo" 
    style="display:none; max-height:100%; border-radius:18px;" 
    muted 
    autoplay 
    playsinline
    controlslist="nodownload nofullscreen noremoteplayback"
></video>

</div>

    <div class="panel bottom">
      <div class="schedule" id="schedule"></div>
    </div>
  </div>

</div>

<div class="logo"><img src="https://www.al-irchadskolen.dk/wp-content/uploads/2024/03/images.png" alt="logo"></div>


<!-- Include audio elements -->
<audio id="morgensamlingSound" src="https://raw.githubusercontent.com/ihayek86-spec/Infoscreen/a45ddd605ea18a69772f1352c39d63a2d9748be2/sounds/morgensamling.mp3" muted></audio>
<audio id="gardvagtSound" src="https://raw.githubusercontent.com/ihayek86-spec/Infoscreen/a45ddd605ea18a69772f1352c39d63a2d9748be2/sounds/husk_gardvagt.mp3" muted></audio>
<audio id="huskGardvagtSound" src="https://raw.githubusercontent.com/ihayek86-spec/Infoscreen/a45ddd605ea18a69772f1352c39d63a2d9748be2/sounds/husk_gardvagt.mp3" muted></audio>

<div id="morgensamlingReminder" style="position:fixed;bottom:50px;left:50%;transform:translateX(-50%);background:red;color:white;padding:12px 20px;border-radius:8px;font-size:20px;font-weight:700;display:none;z-index:15000">
  Det er tid til morgensamling!
</div>


<script>
// TV browser zoom reset
document.body.style.zoom = "1.0";
setInterval(() => {
    document.body.style.zoom = "1.0";
}, 30000); // reset every 30 sec (very light)
// Reset scroll position (TV auto-scroll bug)
setInterval(() => {
    window.scrollTo(0, 0);
}, 5000);


// ===== Date & Time for vikarskema =====
const vikarDateEl = document.getElementById("vikarskemaDate");
const vikarClock = document.getElementById("vikarskemaClock");

function updateVikarskemaClock() {
  const now = new Date();
  vikarClock.textContent = String(now.getHours()).padStart(2,"0") + ":" +
                           String(now.getMinutes()).padStart(2,"0") + ":" +
                           String(now.getSeconds()).padStart(2,"0");
}

function updateVikarskemaDateTime() {
  const now = new Date();
  vikarDateEl.textContent = now.toLocaleDateString('da-DK', {
    weekday:'long', year:'numeric', month:'long', day:'numeric'
  });
  updateVikarskemaClock();
}

setInterval(updateVikarskemaDateTime, 1000);
updateVikarskemaDateTime();

// ===== Local schedules fallback =====
const localSchedules = {
  1:{title:"G√•rdvagtskema", rows:[["9:10-09:20","PP","EY","JL","TN","MA"],["10:50-11:15","PP","NC","LC","JD","MA"],["12:35-12:50","PP","JL","KP","JD","SR"]]},
  2:{title:"G√•rdvagtskema", rows:[["9:10-09:20","NC","EY","EK","TN","IR"],["10:50-11:15","MD","EY","EK","TN","IR"],["12:35-12:50","MD","JL","EK","IH","SR"]]},
  3:{title:"G√•rdvagtskema", rows:[["9:10-09:20","NC","AD","SJ","LL","JL"],["10:50-11:15","ZA","AD","SJ","IH","LL"],["12:35-12:50","ZA","AD","SJ","AFH","LL"]]},
  4:{title:"G√•rdvagtskema", rows:[["9:10-09:20","NC","EY","MB","AFH","MT"],["10:50-11:15","HR","LC","MP","MT","SR"],["12:35-12:50","MD","HR","MP","IH","JD"]]},
  5:{title:"G√•rdvagtskema", rows:[["9:10-09:20","AD","MB","KP","MT","MA"],["10:50-11:15","MA","MB","MP","AFH","MT"]]}
};

function renderSchedule(){
  const today = new Date().getDay();
  const el = document.getElementById("schedule");
  const sch = localSchedules[today] || {title:"Ingen skema i dag", rows:[["-","-","-","-","-","-"]]};
  let html = `<table><thead><tr><th colspan="${Math.max(6,sch.rows[0].length)}">${sch.title}</th></tr><tr><th>Pause</th><th>SG1</th><th>SG2</th><th>MB3</th><th>SG4</th><th>G5</th></tr></thead><tbody>`;
  sch.rows.forEach(r => { html += "<tr>" + r.map(c => `<td>${c}</td>`).join("") + "</tr>"; });
  html += "</tbody></table>";
  el.innerHTML = html;
}
renderSchedule();

// ===== Vikarskema fetch with fallback =====
async function updateVikarskema(){
  const content = document.getElementById("vikarskemaContent");
  const vikarUrl = "https://script.google.com/macros/s/AKfycbyQ5e7UHSmfxdAGJgfAo7mHHnH37ktEIHO0QPEP7TxOlSZ0Tb5lwTAO_9MBtqZG4vSvWw/exec";
  try {
    const res = await fetch(vikarUrl, {cache:"no-store"});
    if(!res.ok) throw new Error(res.status);
    const data = await res.json();
    if(!data || !Array.isArray(data.rows) || !Array.isArray(data.headers)) throw new Error("Invalid JSON");

    let html = "<table><thead><tr>" + data.headers.map(h=>`<th>${h}</th>`).join("") + "</tr></thead><tbody>";
    data.rows.forEach(r => {
      html += "<tr>" + r.map(cell =>
        cell.match(/\.(jpg|jpeg|png|gif|webp)$/i) ? 
        `<td><img src="${cell}" style="max-width:120px;max-height:80px;border-radius:8px"></td>` :
        `<td>${cell}</td>`
      ).join("") + "</tr>";
    });
    html += "</tbody></table>";
    content.innerHTML = html;
    highlightCurrentVikarskemaRow();
  } catch(e){
    const today = new Date().getDay();
    const sch = localSchedules[today] || {title:"Vikarskema", rows:[["Ingen data"]]};
    let html = `<table><thead><tr><th colspan="${Math.max(1,(sch.rows[0]||[]).length)}">${sch.title}</th></tr></thead><tbody>`;
    sch.rows.forEach(r => { html += "<tr>" + r.map(c=>`<td>${c}</td>`).join("") + "</tr>"; });
    html += "</tbody></table>";
    content.innerHTML = html;
  }
}
updateVikarskema();
setInterval(updateVikarskema, 60000);

// ===== Highlight current row =====
function highlightCurrentVikarskemaRow() {
  const content = document.getElementById("vikarskemaContent");
  if (!content) return;

  const now = new Date();
  const nowMinutes = now.getHours() * 60 + now.getMinutes();

  const rows = content.querySelectorAll("tbody tr");

  rows.forEach(row => {
    // Reset all cells to default first
    Array.from(row.cells).forEach(c => {
      c.classList.remove("current");
      c.style.backgroundColor = "";
      c.style.color = "";
    });

    // Function to highlight a range of columns
    function checkAndHighlight(cellIndexStart, cellIndexEnd) {
      const cell = row.cells[cellIndexStart];
      if (!cell) return;

      // Find the last time in the cell text (HH:MM)
      const matches = cell.textContent.match(/(\d{1,2}):(\d{2})/g);
      if (!matches || matches.length === 0) return;

      const lastTime = matches[matches.length - 1];
      const [h, m] = lastTime.split(":").map(Number);

      const startMin = h * 60 + m;  // 5 min before
      const endMin = h * 60 + m + 40;   // 40 min lesson

      if (nowMinutes >= startMin && nowMinutes < endMin) {
        for (let i = cellIndexStart; i <= cellIndexEnd; i++) {
          if (row.cells[i]) {
            row.cells[i].classList.add("current");
            row.cells[i].style.backgroundColor = "#ff4d4d"; // red
            row.cells[i].style.color = "#fff";
          }
        }
      }
    }

    // Highlight columns 1-5 based on first cell
    checkAndHighlight(0, 4);

    // Highlight columns 7-11 based on 7th cell
    checkAndHighlight(6, 10);
  });
}

// Run every 30 seconds (or 10 sec for faster updates)
setInterval(highlightCurrentVikarskemaRow, 10000);
highlightCurrentVikarskemaRow(); // run immediately
// ===== Image slideshow from Google Sheet =====
const webhookUrl="https://script.google.com/macros/s/AKfycbwic1LHHatZ_tAehcE4Hvb-QV-m_ua0k0Hedgre_URMhm8Sva2Bf3QltFN9tOCiJJP1Xw/exec";
let imageData = [];
let currentImageIndex = 0;

const slideshowImg = document.getElementById("slideshowImage");
const slideshowVideo = document.getElementById("slideshowVideo");

function isVideo(url) {
  return url.match(/\.(mp4|webm|ogg)$/i);
}

async function fetchImages(){
  try{
    const res = await fetch(webhookUrl,{cache:"no-store"});
    const data = await res.json();
    imageData = Array.isArray(data) ? data : data.rows || [];
    imageData = imageData
      .map(r => Array.isArray(r) ? r.find(c => typeof c === "string") : r.img)
      .filter(Boolean);
  }catch(e){
    console.error("Failed to fetch slideshow items:", e);
    imageData = [];
  }
}

function showSlide() {
  const url = imageData[currentImageIndex];

  // Image
  if (!isVideo(url)) {
    slideshowVideo.style.display = "none";
    slideshowVideo.pause();

    slideshowImg.style.display = "block";
    slideshowImg.src = url;

    // Move on after 5 seconds
    setTimeout(nextSlide, 5000);
  } 
  // Video
  else {
    slideshowImg.style.display = "none";
    slideshowImg.src = "";

    slideshowVideo.style.display = "block";
    slideshowVideo.src = url;
    slideshowVideo.load();
    slideshowVideo.play();

    // When video ends ‚Üí go to next slide
    slideshowVideo.onended = nextSlide;
  }
}

function nextSlide() {
  currentImageIndex = (currentImageIndex + 1) % imageData.length;
  showSlide();
}

async function initSlideshow(){
  await fetchImages();
  if (imageData.length > 0) showSlide();

  // Refresh data every minute
  setInterval(fetchImages, 60000);
}

initSlideshow();

// ===== InfoBox =====
let currentWeather={desc:"-", temp:"-"};
const infoBoxEl=document.getElementById("infoBox");
const infoItems=[()=>`‚òÄÔ∏è Vejr i Helsing√∏r: ${currentWeather.desc}, ${currentWeather.temp}`];
const infoSheetUrl="https://script.google.com/macros/s/AKfycbwPfXNL6-gcGdxDWd8FXeBej4mJFnutlgApxtzPelYwk2W_L1MoQS8kYpHunsB17PYutA/exec";
let sheetRows=[], currentInfoIndex=0;

async function fetchWeather(){
  try{
    const res = await fetch("https://api.open-meteo.com/v1/forecast?latitude=56.03&longitude=12.59&current_weather=true&temperature_unit=celsius");
    const data = await res.json();
    currentWeather.temp = Math.round(data.current_weather.temperature)+"¬∞C";
    currentWeather.desc = `Vind ${data.current_weather.windspeed} km/t`;
  }catch(e){currentWeather.temp="-"; currentWeather.desc="Fejl";}
}

async function fetchSheetRows(){
  try{
    const res = await fetch(infoSheetUrl,{cache:"no-store"});
    const data = await res.json();
    sheetRows = (data.sheets && data.sheets[0]?.rows) || data.rows || [];
    if(sheetRows.length===0) sheetRows=[["Ingen data fra sheet"]];
  }catch(e){sheetRows=[["Fejl ved hentning af data"]];}
}

async function showInfoBox(){
  infoBoxEl.classList.remove("show");
  setTimeout(()=>{
    let text;
    if(currentInfoIndex<infoItems.length){ text = (typeof infoItems[currentInfoIndex]==="function")?infoItems[currentInfoIndex]():infoItems[currentInfoIndex]; }
    else{ const idx = (currentInfoIndex-infoItems.length)%sheetRows.length; text = (sheetRows[idx]||[""]).join(" | "); }
    infoBoxEl.textContent=text;
    infoBoxEl.classList.add("show");
    currentInfoIndex = (currentInfoIndex+1) % (infoItems.length + Math.max(1,sheetRows.length));
  },400);
}

async function initInfoBox(){
  await fetchSheetRows();
  await fetchWeather();
  showInfoBox();
  setInterval(showInfoBox, 10000);
  setInterval(fetchSheetRows,60000);
  setInterval(fetchWeather,60000);
}
initInfoBox();


function checkMorgensamlingReminder() {
  const now = new Date();
  const hours = now.getHours();
  const minutes = now.getMinutes();
  const reminder = document.getElementById("morgensamlingReminder");

  // Show between 08:20 and 08:30
  if (hours === 8 && minutes >= 20 && minutes < 30) {
    reminder.style.display = "block";
  } else {
    reminder.style.display = "none";
  }
}

// Check every 10 seconds
setInterval(checkMorgensamlingReminder, 10000);
checkMorgensamlingReminder();

// Reload the page every 10 minutes to prevent freezing
setInterval(() => {
    location.reload();
}, 600000); // 600,000 ms = 10 minutes


</script>
</body>
</html>

